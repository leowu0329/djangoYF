{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h1 class="card-title mb-0">{{ case.caseNumber }}</h1>
      <a href="{% url 'case_list' %}" class="btn btn-secondary">
        <i class="bi bi-arrow-left-circle"></i> 返回案件列表
      </a>
    </div>
    <div class="card-body">
      <!-- Tabs -->
      <ul class="nav nav-tabs" id="caseTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab" aria-controls="details" aria-selected="true">
            <i class="bi bi-info-circle"></i> 詳情
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="lands-tab" data-bs-toggle="tab" data-bs-target="#lands" type="button" role="tab" aria-controls="lands" aria-selected="false">
            <i class="bi bi-map"></i> 土地資訊({{ case.total_calculated_land_area_display }})
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="builds-tab" data-bs-toggle="tab" data-bs-target="#builds" type="button" role="tab" aria-controls="builds" aria-selected="false">
            <i class="bi bi-building"></i> 建物資訊({{ case.total_calculated_build_area_display }})
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="people-tab" data-bs-toggle="tab" data-bs-target="#people" type="button" role="tab" aria-controls="people" aria-selected="false">
            <i class="bi bi-people"></i> 人員資訊：{{ case.people_summary_display }}
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="surveys-tab" data-bs-toggle="tab" data-bs-target="#surveys" type="button" role="tab" aria-controls="surveys" aria-selected="false">
            <i class="bi bi-clipboard-data"></i> 勘查 {{ case.survey_links_count_display }}
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="finaldecisions-tab" data-bs-toggle="tab" data-bs-target="#finaldecisions" type="button" role="tab" aria-controls="finaldecisions" aria-selected="false">
            <i class="bi bi-check2-square"></i> 最終判定({% with latest_finaldecision=case.finaldecisions.last %}
              {% if latest_finaldecision and latest_finaldecision.finalDecision %}
                {{ latest_finaldecision.finalDecision }}
              {% else %}
                無記錄
              {% endif %}
            {% endwith %})
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="results-tab" data-bs-toggle="tab" data-bs-target="#results" type="button" role="tab" aria-controls="results" aria-selected="false">
            <i class="bi bi-clipboard-check"></i> 結果({{ case.result_action_result_display }})
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="objectbuilds-tab" data-bs-toggle="tab" data-bs-target="#objectbuilds" type="button" role="tab" aria-controls="objectbuilds" aria-selected="false">
            <i class="bi bi-house"></i> 比價建物({{ case.avg_objectbuild_calculate_display }})
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="auctions-tab" data-bs-toggle="tab" data-bs-target="#auctions" type="button" role="tab" aria-controls="auctions" aria-selected="false">
            <i class="bi bi-gavel"></i> 拍賣({% with latest_auction=case.auctions.last %}
              {% if latest_auction %}
                {% if case.objectbuilds.exists %}
                  CP: {{ latest_auction.calculated_cp_value }}
                  {% if latest_auction.type == '1拍' and latest_auction.calculated_cp_value > 0.92 or latest_auction.type == '2拍' and latest_auction.calculated_cp_value > 1.15 or latest_auction.type == '3拍' and latest_auction.calculated_cp_value > 1.44 or latest_auction.type == '4拍' and latest_auction.calculated_cp_value > 1.80 %}
                    [建議進場]
                  {% else %}
                    [不可進場]
                  {% endif %}
                {% else %}
                  無時價記錄
                {% endif %}
              {% else %}
                無記錄
              {% endif %}
            {% endwith %})
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="officialdocuments-tab" data-bs-toggle="tab" data-bs-target="#officialdocuments" type="button" role="tab" aria-controls="officialdocuments" aria-selected="false">
            <i class="bi bi-file-text"></i> 公文 ({% if case.officialdocuments.count > 0 %}{{ case.officialdocuments.count }}{% else %}0{% endif %})
          </button>
        </li>
      </ul>

      <div class="tab-content pt-3" id="caseTabContent">
        <!-- Details Tab -->
        <div class="tab-pane fade show active" id="details" role="tabpanel" aria-labelledby="details-tab">
          <div class="table-responsive">
            <table class="table table-sm table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th>狀態</th>
                  <th>案號</th>
                  <th>地址</th>
                  <th>公司</th>
                  <th>負責人</th>
                  <th class="text-end">操作</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>
                    {% if case.status == "在途" %}
                      <span class="badge rounded-pill bg-warning text-dark fs-6">{{ case.status }}</span>
                    {% elif case.status == "結案" %}
                      <span class="badge rounded-pill bg-success fs-6">{{ case.status }}</span>
                    {% else %}
                      <span class="badge rounded-pill bg-secondary fs-6">{{ case.status }}</span>
                    {% endif %}
                  </td>
                  <td>{{ case.caseNumber }}</td>
                  <td>{{ case.fullAddress|default:"—" }}</td>
                  <td>{{ case.company|default:"—" }}</td>
                  <td>{{ case.user.profile.nickname|default:case.user.username }}</td>
                  <td class="text-end">
                    <a href="{% url 'case_update' case.id %}" class="btn btn-sm btn-outline-primary">
                      <i class="bi bi-pencil"></i>
                    </a>
                    <a href="{% url 'case_delete' case.id %}" class="btn btn-sm btn-outline-danger">
                      <i class="bi bi-trash"></i>
                    </a>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Lands Tab -->
        <div class="tab-pane fade" id="lands" role="tabpanel" aria-labelledby="lands-tab">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">土地</h5>
            <a href="{% url 'land_create' case_pk=case.id %}" class="btn btn-sm btn-success">
              <i class="bi bi-plus-circle"></i> 新增土地
            </a>
          </div>
          {% if case.lands.all %}
            <div class="table-responsive">
              <table class="table table-sm table-hover align-middle">
                <thead class="table-light">
                  <tr>
                    <th>地號</th>
                    <th>地坪(平方公尺)</th>
                    <th>個人持分</th>
                    <th>所有持分</th>
                    <th>計算後地坪(坪)</th>
                    <th class="text-end">操作</th>
                  </tr>
                </thead>
                <tbody>
                  {% for land in case.lands.all %}
                    <tr>
                      <td>
                        {% if land.url %}
                          <a href="{{ land.url }}" target="_blank" class="text-decoration-none">{{ land.formatted_landNumber }}</a>
                        {% else %}
                          {{ land.formatted_landNumber }}
                        {% endif %}
                      </td>
                      <td>{{ land.area }}</td>
                      <td>{{ land.holdingPointPersonal }}</td>
                      <td>{{ land.holdingPointAll }}</td>
                      <td>{{ land.calculatedArea }}</td>
                      <td class="text-end">
                        <a href="{% url 'land_update' land.id %}" class="btn btn-sm btn-outline-primary">
                          <i class="bi bi-pencil"></i>
                        </a>
                        <a href="{% url 'land_delete' land.id %}" class="btn btn-sm btn-outline-danger">
                          <i class="bi bi-trash"></i>
                        </a>
                      </td>
                    </tr>
                  {% empty %}
                    <tr><td colspan="6" class="text-center text-muted">無土地記錄。</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="alert alert-info">無土地記錄。</div>
          {% endif %}
        </div>

        <!-- Builds Tab -->
        <div class="tab-pane fade" id="builds" role="tabpanel" aria-labelledby="builds-tab">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">建物</h5>
            <a href="{% url 'build_create' case_pk=case.id %}" class="btn btn-sm btn-success">
              <i class="bi bi-plus-circle"></i> 新增建物
            </a>
          </div>
          {% if case.builds.all %}
            <div class="table-responsive">
              <table class="table table-sm table-hover align-middle">
                <thead class="table-light">
                  <tr>
                    <th>建號</th>
                    <th>建坪(平方公尺)</th>
                    <th>個人持分</th>
                    <th>所有持分</th>
                    <th>計算後建坪</th>
                    <th>建物型</th>
                    <th>使用分區</th>
                    <th class="text-end">操作</th>
                  </tr>
                </thead>
                <tbody>
                  {% for build in case.builds.all %}
                    <tr>
                      <td>
                        {% if build.url %}
                          <a href="{{ build.url }}" target="_blank" class="text-decoration-none">{{ build.formatted_buildNumber }}</a>
                        {% else %}
                          {{ build.formatted_buildNumber }}
                        {% endif %}
                      </td>
                      <td>{{ build.area }}</td>
                      <td>{{ build.holdingPointPersonal }}</td>
                      <td>{{ build.holdingPointAll }}</td>
                      <td>{{ build.calculatedArea }}</td>
                      <td>{{ build.typeUse }}</td>
                      <td>{{ build.usePartition }}</td>
                      <td class="text-end">
                        <a href="{% url 'build_update' build.id %}" class="btn btn-sm btn-outline-primary">
                          <i class="bi bi-pencil"></i>
                        </a>
                        <a href="{% url 'build_delete' build.id %}" class="btn btn-sm btn-outline-danger">
                          <i class="bi bi-trash"></i>
                        </a>
                      </td>
                    </tr>
                  {% empty %}
                    <tr><td colspan="8" class="text-center text-muted">無建物記錄。</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="alert alert-info">無建物記錄。</div>
          {% endif %}
        </div>

        <!-- People Tab -->
        <div class="tab-pane fade" id="people" role="tabpanel" aria-labelledby="people-tab">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">人員</h5>
            <a href="{% url 'person_create' case_pk=case.id %}" class="btn btn-sm btn-success">
              <i class="bi bi-plus-circle"></i> 新增人員
            </a>
          </div>
          {% if case.people.all %}
            <div class="table-responsive">
              <table class="table table-sm table-hover align-middle">
                <thead class="table-light">
                  <tr>
                    <th>姓名</th>
                    <th>分類</th>
                    <th>電話</th>
                    <th class="text-end">操作</th>
                  </tr>
                </thead>
                <tbody>
                  {% for person in case.people.all %}
                    <tr>
                      <td>{{ person.name }}</td>
                      <td>{{ person.type }}</td>
                      <td>{{ person.phone }}</td>
                      <td class="text-end">
                        <a href="{% url 'person_update' person.id %}" class="btn btn-sm btn-outline-primary">
                          <i class="bi bi-pencil"></i>
                        </a>
                        <a href="{% url 'person_delete' person.id %}" class="btn btn-sm btn-outline-danger">
                          <i class="bi bi-trash"></i>
                        </a>
                      </td>
                    </tr>
                  {% empty %}
                    <tr><td colspan="4" class="text-center text-muted">無人員記錄。</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="alert alert-info">無人員記錄。</div>
          {% endif %}
        </div>

        <!-- Surveys Tab -->
        <div class="tab-pane fade" id="surveys" role="tabpanel" aria-labelledby="surveys-tab">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">勘查</h5>
            <a href="{% url 'survey_create' case_pk=case.id %}" class="btn btn-sm btn-success">
              <i class="bi bi-plus-circle"></i> 新增勘查
            </a>
          </div>
          {% if case.surveys.all %}
            <div class="table-responsive">
              <table class="table table-sm table-hover align-middle">
                <thead class="table-light">
                  <tr>
                    <th>初勘日</th>
                    <th>會勘日</th>
                    <th>法拍公告</th>
                    <th>998</th>
                    <th>物件照片</th>
                    <th>市場行情</th>
                    <th>法拍記錄</th>
                    <th>現場勘查</th>
                    <th>收發文薄</th>
                    <th>流水帳</th>
                    <th class="text-end">操作</th>
                  </tr>
                </thead>
                <tbody>
                  {% for s in case.surveys.all %}
                    <tr>
                      <td>{{ s.firstDay|date:"Y-m-d"|default:"—" }}</td>
                      <td>{{ s.secondDay|date:"Y-m-d"|default:"—" }}</td>
                      <td>{% if s.foreclosureAnnouncementLink %}<a href="{{ s.foreclosureAnnouncementLink }}" target="_blank">連結</a>{% else %}<span class="text-muted">—</span>{% endif %}</td>
                      <td>{% if s.house988Link %}<a href="{{ s.house988Link }}" target="_blank">連結</a>{% else %}<span class="text-muted">—</span>{% endif %}</td>
                      <td>{% if s.objectPhotoLink %}<a href="{{ s.objectPhotoLink }}" target="_blank">連結</a>{% else %}<span class="text-muted">—</span>{% endif %}</td>
                      <td>{% if s.netMarketPriceLink %}<a href="{{ s.netMarketPriceLink }}" target="_blank">連結</a>{% else %}<span class="text-muted">—</span>{% endif %}</td>
                      <td>{% if s.foreclosureRecordLink %}<a href="{{ s.foreclosureRecordLink }}" target="_blank">連結</a>{% else %}<span class="text-muted">—</span>{% endif %}</td>
                      <td>{% if s.objectViewLink %}<a href="{{ s.objectViewLink }}" target="_blank">連結</a>{% else %}<span class="text-muted">—</span>{% endif %}</td>
                      <td>{% if s.pagesViewLink %}<a href="{{ s.pagesViewLink }}" target="_blank">連結</a>{% else %}<span class="text-muted">—</span>{% endif %}</td>
                      <td>{% if s.moneytViewLink %}<a href="{{ s.moneytViewLink }}" target="_blank">連結</a>{% else %}<span class="text-muted">—</span>{% endif %}</td>
                      <td class="text-end">
                        <a href="{% url 'survey_update' s.id %}" class="btn btn-sm btn-outline-primary"><i class="bi bi-pencil"></i></a>
                        <a href="{% url 'survey_delete' s.id %}" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></a>
                      </td>
                    </tr>
                  {% empty %}
                    <tr><td colspan="11" class="text-center text-muted">無勘查記錄。</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="alert alert-info">無勘查記錄。</div>
          {% endif %}
        </div>

        <!-- Final Decisions Tab -->
        <div class="tab-pane fade" id="finaldecisions" role="tabpanel" aria-labelledby="finaldecisions-tab">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">最終判定</h5>
            <a href="{% url 'finaldecision_create' case_pk=case.id %}" class="btn btn-sm btn-success">
              <i class="bi bi-plus-circle"></i> 新增最終判定
            </a>
          </div>
          {% if case.finaldecisions.all %}
            <div class="table-responsive">
              <table class="table table-sm table-hover align-middle">
                <thead class="table-light">
                  <tr>
                    <th>最終判定</th>
                    <th>分類</th>
                    <th>人員</th>
                    <th>日期</th>
                    <th>工作轄區</th>
                    <th>備註</th>
                    <th class="text-end">操作</th>
                  </tr>
                </thead>
                <tbody>
                  {% for fd in case.finaldecisions.all %}
                    <tr>
                      <td>{{ fd.finalDecision }}</td>
                      <td>{{ fd.type }}</td>
                      <td>{{ fd.name }}</td>
                      <td>{{ fd.date|date:"Y-m-d"|default:"—" }}</td>
                      <td>{{ fd.workArea }}</td>
                      <td class="text-truncate" style="max-width: 420px;">{{ fd.remark }}</td>
                      <td class="text-end">
                        <a href="{% url 'finaldecision_update' fd.id %}" class="btn btn-sm btn-outline-primary"><i class="bi bi-pencil"></i></a>
                        <a href="{% url 'finaldecision_delete' fd.id %}" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></a>
                      </td>
                    </tr>
                  {% empty %}
                    <tr><td colspan="7" class="text-center text-muted">無最終判定記錄。</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="alert alert-info">無最終判定記錄。</div>
          {% endif %}
        </div>

        <!-- Results Tab -->
        <div class="tab-pane fade" id="results" role="tabpanel" aria-labelledby="results-tab">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">結果</h5>
            <a href="{% url 'result_create' case_pk=case.id %}" class="btn btn-sm btn-success">
              <i class="bi bi-plus-circle"></i> 新增結果
            </a>
          </div>
          {% if case.results.all %}
            <div class="table-responsive">
              <table class="table table-sm table-hover align-middle">
                <thead class="table-light">
                  <tr>
                    <th>應買止日</th>
                    <th>執行結果</th>
                    <th>搶標拍別</th>
                    <th>搶標金額</th>
                    <th>標的編號</th>
                    <th class="text-end">操作</th>
                  </tr>
                </thead>
                <tbody>
                  {% for result in case.results.all %}
                    <tr>
                      <td>{{ result.stopBuyDate|date:"Y-m-d"|default:"—" }}</td>
                      <td>{{ result.actionResult|default:"—" }}</td>
                      <td>{{ result.bidAuctionTime|default:"—" }}</td>
                      <td>{{ result.bidMoney|default:"—" }}</td>
                      <td>{{ result.objectNumber|default:"—" }}</td>
                      <td class="text-end">
                        <a href="{% url 'result_update' result.id %}" class="btn btn-sm btn-outline-primary"><i class="bi bi-pencil"></i></a>
                        <a href="{% url 'result_delete' result.id %}" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></a>
                      </td>
                    </tr>
                  {% empty %}
                    <tr><td colspan="6" class="text-center text-muted">無結果記錄。</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="alert alert-info">無結果記錄。</div>
          {% endif %}
        </div>

        <!-- Object Builds Tab -->
        <div class="tab-pane fade" id="objectbuilds" role="tabpanel" aria-labelledby="objectbuilds-tab">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">比價建物</h5>
            <a href="{% url 'objectbuild_create' case_pk=case.id %}" class="btn btn-sm btn-success">
              <i class="bi bi-plus-circle"></i> 新增比價建物
            </a>
          </div>
          {% if case.objectbuilds.all %}
            <div class="table-responsive">
              <table class="table table-sm table-hover align-middle">
                <thead class="table-light">
                  <tr>
                    <th>參考物件訊息</th>
                    <th colspan="1">加成</th>
                    <th>計算</th>
                    <th class="text-end">操作</th>
                  </tr>
                </thead>
                <tbody>
                  {% for ob in case.objectbuilds.all %}
                    <tr>
                      <td>
                        類型: {{ ob.type }}<br>
                        地址: {{ ob.address }}<br>
                        附件: {% if ob.url %}<a href="{{ ob.url }}" target="_blank">連結</a>{% else %}<span class="text-muted">—</span>{% endif %}<br>
                        屋齡(年): {{ ob.houseAge }}<br>
                        成交日期: {{ ob.transactionDate|date:"Y-m-d"|default:"—" }}<br>
                        樓高: {{ ob.floorHeight }}<br>
                        總價: {{ ob.totalPrice }}<br>
                        建坪(坪): {{ ob.buildArea }}<br>
                        增建坪數(坪): {{ ob.subBuildArea }}<br>
                        單價: {{ ob.unitPrice }}
                      </td>
                      <td>
                        <table class="table table-sm table-borderless mb-0">
                          <thead>
                            <tr>
                              <th>勘查員</th>
                              <th>加成</th>
                              <th>加成原因</th>
                              <th>操作</th>
                            </tr>
                          </thead>
                          <tbody>
                            {% for bouns in ob.bounses.all %}
                                <tr>
                                  <td>{{ bouns.display_bouns_person }}</td>
                                  <td>{{ bouns.bounsRate }}</td>
                                  <td>{{ bouns.bounsReason }}</td>
                                  <td>
                                    <a href="{% url 'bouns_update' bouns.id %}" class="btn btn-sm btn-outline-primary"><i class="bi bi-pencil"></i></a>
                                    <a href="{% url 'bouns_delete' bouns.id %}" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></a>
                                  </td>
                                </tr>
                              {% empty %}
                                <tr><td colspan="4" class="text-muted">無加成記錄。</td></tr>
                            {% endfor %}
                          </tbody>
                        </table>
                        <a href="{% url 'bouns_create' objectbuild_pk=ob.id %}" class="btn btn-sm btn-success mt-2">
                          <i class="bi bi-plus-circle"></i> 新增加成
                        </a>
                      </td>
                      <td>{{ ob.calculate }}</td>
                      <td class="text-end">
                        <a href="{% url 'objectbuild_update' ob.id %}" class="btn btn-sm btn-outline-primary"><i class="bi bi-pencil"></i></a>
                        <a href="{% url 'objectbuild_delete' ob.id %}" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></a>
                      </td>
                    </tr>
                  {% empty %}
                    <tr><td colspan="4" class="text-center text-muted">無比價建物記錄。</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="alert alert-info">無比價建物記錄。</div>
          {% endif %}
        </div>

        <!-- Auctions Tab -->
        <div class="tab-pane fade" id="auctions" role="tabpanel" aria-labelledby="auctions-tab">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">拍賣</h5>
            <a href="{% url 'auction_create' case_pk=case.id %}" class="btn btn-sm btn-success">
              <i class="bi bi-plus-circle"></i> 新增拍賣
            </a>
          </div>
          {% if case.auctions.all %}
            <div class="table-responsive">
              <table class="table table-sm table-hover align-middle">
                <thead class="table-light">
                  <tr>
                    <th>拍別</th>
                    <th>拍賣日</th>
                    <th>底價</th>
                    <th>坪價</th>
                    <th>CP</th>
                    <th>點閱</th>
                    <th>監控</th>
                    <th>成交件數</th>
                    <th>保証金</th>
                    <th class="text-end">操作</th>
                  </tr>
                </thead>
                <tbody>
                  {% for auction in case.auctions.all %}
                    <tr>
                      <td>{{ auction.type }}</td>
                      <td>{{ auction.auctionDate|date:"Y-m-d" }}</td>
                      <td>{{ auction.floorPrice }}</td>
                      <td>{{ auction.pingPrice }}</td>
                      <td>
                        {% if auction.type == '1拍' and auction.calculated_cp_value > 0.92 or auction.type == '2拍' and auction.calculated_cp_value > 1.15 or auction.type == '3拍' and auction.calculated_cp_value > 1.44 or auction.type == '4拍' and auction.calculated_cp_value > 1.80 %}
                          <span class="bg-white text-success fw-bold">{{ auction.calculated_cp_value }} (建議進場)</span>
                        {% else %}
                          <span class="bg-white text-danger fw-bold">{{ auction.calculated_cp_value }} (不可進場)</span>
                        {% endif %}
                      </td>
                      <td>{{ auction.click }}</td>
                      <td>{{ auction.monitor }}</td>
                      <td>{{ auction.caseCount }}</td>
                      <td>{{ auction.margin }}</td>
                      <td class="text-end">
                        <a href="{% url 'auction_update' auction.id %}" class="btn btn-sm btn-outline-primary"><i class="bi bi-pencil"></i></a>
                        <a href="{% url 'auction_delete' auction.id %}" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></a>
                      </td>
                    </tr>
                  {% empty %}
                    <tr><td colspan="10" class="text-center text-muted">無拍賣記錄。</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="alert alert-info">無拍賣記錄。</div>
          {% endif %}
        </div>

        <!-- Official Documents Tab -->
        <div class="tab-pane fade" id="officialdocuments" role="tabpanel" aria-labelledby="officialdocuments-tab">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">公文</h5>
            <a href="{% url 'officialdocument_create' case_pk=case.id %}" class="btn btn-sm btn-success">
              <i class="bi bi-plus-circle"></i> 新增公文
            </a>
          </div>
          {% if case.officialdocuments.all %}
            <div class="table-responsive">
              <table class="table table-sm table-hover align-middle">
                <thead class="table-light">
                  <tr>
                    <th>案別</th>
                    <th>股別</th>
                    <th>案號</th>
                    <th>電話</th>
                    <th>分機</th>
                    <th>建立時間</th>
                    <th class="text-end">操作</th>
                  </tr>
                </thead>
                <tbody>
                  {% for doc in case.officialdocuments.all %}
                    <tr>
                      <td>{{ doc.type }}</td>
                      <td>{{ doc.stock }}</td>
                      <td>{{ doc.docNumber }}</td>
                      <td>{{ doc.tel }}</td>
                      <td>{{ doc.ext }}</td>
                      <td>{{ doc.created|date:"Y-m-d H:i" }}</td>
                      <td class="text-end">
                        <a href="{% url 'officialdocument_detail' doc.id %}" class="btn btn-sm btn-outline-info"><i class="bi bi-eye"></i></a>
                        <a href="{% url 'officialdocument_update' doc.id %}" class="btn btn-sm btn-outline-primary"><i class="bi bi-pencil"></i></a>
                        <a href="{% url 'officialdocument_delete' doc.id %}" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></a>
                      </td>
                    </tr>
                  {% empty %}
                    <tr><td colspan="6" class="text-center text-muted">無公文記錄。</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="alert alert-info">無公文記錄。</div>
          {% endif %}
        </div>
      </div>

    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const hash = window.location.hash;
    console.log('Current URL hash:', hash);
    if (hash) {
      const triggerEl = document.querySelector(`button[data-bs-target="${hash}"]`);
      console.log('Trigger element found:', triggerEl);
      if (triggerEl) {
        // Ensure Bootstrap's Tab is available
        if (window.bootstrap && window.bootstrap.Tab) {
          const tab = new window.bootstrap.Tab(triggerEl);
          tab.show();
          console.log('Tab activated:', hash);
        } else {
          console.error('Bootstrap Tab JavaScript not loaded or initialized.');
        }
      } else {
        console.warn('No tab button found for hash:', hash);
      }
    }
  });
</script>
{% endblock %}
