{% extends 'base.html' %}
{% load widget_tweaks %}

{% block content %}
<div class="container mt-4">
  <div class="card">
    <div class="card-header bg-primary text-white">
      <h1 class="card-title">{% if form.instance.pk %}編輯案件{% else %}建立新案件{% endif %}</h1>
    </div>
    <div class="card-body">
      <form method="post">
        {% csrf_token %}

        <!-- Row 1: 案號(*) + 所屬公司 -->
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="{{ form.caseNumber.id_for_label }}" class="form-label">{{ form.caseNumber.label }}</label>
            {{ form.caseNumber|add_class:"form-control" }}
            {% if form.caseNumber.help_text %}<div class="form-text">{{ form.caseNumber.help_text }}</div>{% endif %}
            {% for error in form.caseNumber.errors %}<div class="alert alert-danger mt-1">{{ error }}</div>{% endfor %}
          </div>
          <div class="col-md-6 mb-3">
            <label for="{{ form.company.id_for_label }}" class="form-label">{{ form.company.label }}</label>
            {{ form.company|add_class:"form-select" }}
            {% if form.company.help_text %}<div class="form-text">{{ form.company.help_text }}</div>{% endif %}
            {% for error in form.company.errors %}<div class="alert alert-danger mt-1">{{ error }}</div>{% endfor %}
          </div>
        </div>

        <!-- Row 2: 縣市 + 鄉鎮區里 -->
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="{{ form.city.id_for_label }}" class="form-label">{{ form.city.label }}</label>
            {{ form.city|add_class:"form-control"|attr:"id:id_city" }}
            {% if form.city.help_text %}<div class="form-text">{{ form.city.help_text }}</div>{% endif %}
            {% for error in form.city.errors %}<div class="alert alert-danger mt-1">{{ error }}</div>{% endfor %}
          </div>
          <div class="col-md-6 mb-3">
            <label for="{{ form.township.id_for_label }}" class="form-label">{{ form.township.label }}</label>
            {{ form.township|add_class:"form-control"|attr:"id:id_township" }}
            {% if form.township.help_text %}<div class="form-text">{{ form.township.help_text }}</div>{% endif %}
            {% for error in form.township.errors %}<div class="alert alert-danger mt-1">{{ error }}</div>{% endfor %}
          </div>
        </div>

        <!-- Rows: 一列四欄 -->
        <div class="row">
          <div class="col-md-3 mb-3">
            <label for="{{ form.bigSection.id_for_label }}" class="form-label">{{ form.bigSection.label }}</label>
            {{ form.bigSection|add_class:"form-control" }}
            {% for error in form.bigSection.errors %}<div class="alert alert-danger mt-1">{{ error }}</div>{% endfor %}
          </div>
          <div class="col-md-3 mb-3">
            <label for="{{ form.section.id_for_label }}" class="form-label">{{ form.section.label }}</label>
            {{ form.section|add_class:"form-control" }}
            {% for error in form.section.errors %}<div class="alert alert-danger mt-1">{{ error }}</div>{% endfor %}
          </div>
          <div class="col-md-3 mb-3">
            <label for="{{ form.village.id_for_label }}" class="form-label">{{ form.village.label }}</label>
            {{ form.village|add_class:"form-control" }}
            {% for error in form.village.errors %}<div class="alert alert-danger mt-1">{{ error }}</div>{% endfor %}
          </div>
          <div class="col-md-3 mb-3">
            <label for="{{ form.neighbor.id_for_label }}" class="form-label">{{ form.neighbor.label }}</label>
            {{ form.neighbor|add_class:"form-control" }}
            {% for error in form.neighbor.errors %}<div class="alert alert-danger mt-1">{{ error }}</div>{% endfor %}
          </div>
        </div>

        <div class="row">
          <div class="col-md-3 mb-3">
            <label for="{{ form.street.id_for_label }}" class="form-label">{{ form.street.label }}</label>
            {{ form.street|add_class:"form-control" }}
            {% for error in form.street.errors %}<div class="alert alert-danger mt-1">{{ error }}</div>{% endfor %}
          </div>
          <div class="col-md-3 mb-3">
            <label for="{{ form.smallSection.id_for_label }}" class="form-label">{{ form.smallSection.label }}</label>
            {{ form.smallSection|add_class:"form-control" }}
            {% for error in form.smallSection.errors %}<div class="alert alert-danger mt-1">{{ error }}</div>{% endfor %}
          </div>
          <div class="col-md-3 mb-3">
            <label for="{{ form.lane.id_for_label }}" class="form-label">{{ form.lane.label }}</label>
            {{ form.lane|add_class:"form-control" }}
            {% for error in form.lane.errors %}<div class="alert alert-danger mt-1">{{ error }}</div>{% endfor %}
          </div>
          <div class="col-md-3 mb-3">
            <label for="{{ form.alley.id_for_label }}" class="form-label">{{ form.alley.label }}</label>
            {{ form.alley|add_class:"form-control" }}
            {% for error in form.alley.errors %}<div class="alert alert-danger mt-1">{{ error }}</div>{% endfor %}
          </div>
        </div>

        <div class="row">
          <div class="col-md-3 mb-3">
            <label for="{{ form.number.id_for_label }}" class="form-label">{{ form.number.label }}</label>
            {{ form.number|add_class:"form-control" }}
            {% for error in form.number.errors %}<div class="alert alert-danger mt-1">{{ error }}</div>{% endfor %}
          </div>
          <div class="col-md-3 mb-3">
            <label for="{{ form.Floor.id_for_label }}" class="form-label">{{ form.Floor.label }}</label>
            {{ form.Floor|add_class:"form-control" }}
            {% for error in form.Floor.errors %}<div class="alert alert-danger mt-1">{{ error }}</div>{% endfor %}
          </div>
          <div class="col-md-3 mb-3">
            <label for="{{ form.status.id_for_label }}" class="form-label">{{ form.status.label }}</label>
            {{ form.status|add_class:"form-control" }}
            {% for error in form.status.errors %}<div class="alert alert-danger mt-1">{{ error }}</div>{% endfor %}
          </div>
        </div>

        <div class="d-flex justify-content-end">
          <button type="submit" class="btn btn-primary me-2">
            <i class="bi bi-save"></i> 儲存
          </button>
          <a href="{% if form.instance.pk %}{% url 'case_detail' form.instance.pk %}{% else %}{% url 'case_list' %}{% endif %}" class="btn btn-outline-secondary">
            <i class="bi bi-x-circle"></i> 取消
          </a>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    var citySelect = document.getElementById('id_city');
    var townshipSelect = document.getElementById('id_township');
    var initialTownshipId = {{ form.instance.township.id|default:"''" }};

    function loadTownships() {
      var cityId = citySelect.value;
      if (cityId) {
        fetch(`/ajax/load-townships/?city_id=${cityId}`)
          .then(async function(response) {
            if (!response.ok) {
              var errorMsg = 'HTTP ' + response.status + ' 錯誤';
              if (response.status === 404) {
                errorMsg = '找不到請求的資源（404錯誤），請檢查URL路徑是否正確';
              } else if (response.status === 400) {
                errorMsg = '請求參數錯誤（400錯誤）';
              } else if (response.status === 500) {
                errorMsg = '伺服器內部錯誤（500錯誤）';
              }
              
              // 嘗試解析JSON錯誤消息
              try {
                var errorData = await response.json();
                if (errorData && errorData.error) {
                  errorMsg = errorData.error;
                }
              } catch (e) {
                // 如果不是JSON，使用預設錯誤消息
              }
              throw new Error(errorMsg);
            }
            return response.json();
          })
          .then(function(data) {
            if (data && data.error) {
              console.error('載入鄉鎮資料失敗:', data.error);
              townshipSelect.innerHTML = '<option value="">載入失敗</option>';
              return;
            }
            townshipSelect.innerHTML = ''; // Clear existing options
            if (Array.isArray(data)) {
              data.forEach(function(township) {
                var option = new Option(township.name, township.id);
                townshipSelect.add(option);
              });
              // Set initial selected township if exists
              if (initialTownshipId) {
                townshipSelect.value = initialTownshipId;
                initialTownshipId = null; // Clear to prevent re-setting on subsequent loads
              }
            }
          })
          .catch(function(error) {
            console.error('載入鄉鎮資料時發生錯誤:', error.message);
            townshipSelect.innerHTML = '<option value="">載入失敗</option>';
          });
      } else {
        townshipSelect.innerHTML = '<option value="">--------</option>';
      }
    }

    // Load townships on city change
    citySelect.addEventListener('change', loadTownships);

    // Initial load if a city is already selected (e.g., on edit page)
    if (citySelect.value) {
      loadTownships();
    }
  });
</script>
{% endblock extra_js %}