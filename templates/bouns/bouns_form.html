{% extends 'base.html' %}
{% load widget_tweaks %}

{% block content %}
<div class="container mt-4">
  <div class="card">
    <div class="card-header bg-primary text-white">
      <h1 class="card-title">{% if form.instance.pk %}Edit Bouns{% else %}Add Bouns{% endif %}</h1>
    </div>
    <div class="card-body">
      <form method="post">
        {% csrf_token %}
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">勘查員</label>
            {{ form.bounsPerson|add_class:"form-select" }}
            {% if form.instance.pk and form.instance.bounsPerson %}
            {# Hidden input to preserve bounsPerson value when field is disabled #}
            <input type="hidden" name="bounsPerson" value="{{ form.instance.bounsPerson.id }}" id="id_bounsPerson_hidden">
            <script>
              // Ensure the select field shows the correct selected value
              document.addEventListener('DOMContentLoaded', function() {
                var selectField = document.getElementById('id_bounsPerson');
                var hiddenField = document.getElementById('id_bounsPerson_hidden');
                if (selectField && hiddenField) {
                  selectField.value = hiddenField.value;
                }
              });
            </script>
            {% endif %}
          </div>
          <div class="col-md-6">
            <label class="form-label">加成</label>
            {{ form.bounsRate|add_class:"form-select" }}
          </div>
          <div class="col-md-12">
            <label class="form-label">加成原因</label>
            {{ form.bounsReason|add_class:"form-select" }}
            {% for error in form.bounsReason.errors %}<div class="alert alert-danger mt-1">{{ error }}</div>{% endfor %}
          </div>
          <div class="col-md-12" id="bounsReasonOtherContainer" style="display: none;">
            <label class="form-label">{{ form.bounsReasonOther.label }}</label>
            {{ form.bounsReasonOther }}
            {% for error in form.bounsReasonOther.errors %}<div class="alert alert-danger mt-1">{{ error }}</div>{% endfor %}
          </div>
          {{ form.objectbuild }}
        </div>

        <div class="d-flex justify-content-end mt-4">
          <button type="submit" class="btn btn-primary me-2">Save</button>
          <a href="{% if form.instance.pk %}{% url 'case_detail' form.instance.objectbuild.cases_id %}{% else %}{% url 'case_detail' objectbuild.cases_id %}{% endif %}" class="btn btn-outline-secondary">Cancel</a>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  var bounsReasonSelect = document.getElementById('id_bounsReason');
  var bounsReasonOtherContainer = document.getElementById('bounsReasonOtherContainer');
  var bounsReasonOtherInput = document.getElementById('id_bounsReasonOther');
  
  function toggleOtherField() {
    if (bounsReasonSelect && bounsReasonOtherContainer && bounsReasonOtherInput) {
      if (bounsReasonSelect.value === '其他') {
        bounsReasonOtherContainer.style.display = 'block';
        bounsReasonOtherInput.style.display = 'block';
        bounsReasonOtherInput.required = true;
      } else {
        bounsReasonOtherContainer.style.display = 'none';
        bounsReasonOtherInput.style.display = 'none';
        bounsReasonOtherInput.required = false;
        // Only clear value if not in "其他" mode
        if (bounsReasonSelect.value !== '其他') {
          bounsReasonOtherInput.value = '';
        }
      }
    }
  }
  
  // Check if initial value is set for "其他" option
  var initialBounsReason = '{{ form.bounsReason.initial|default:"" }}';
  var initialBounsReasonOther = '{{ form.bounsReasonOther.initial|default:"" }}';
  
  // Initial check
  toggleOtherField();
  
  // If editing and we have an "其他" value, set it up
  if (initialBounsReason === '其他' || (initialBounsReasonOther && initialBounsReasonOther.trim() !== '')) {
    if (bounsReasonSelect) {
      bounsReasonSelect.value = '其他';
      toggleOtherField();
      if (bounsReasonOtherInput && initialBounsReasonOther) {
        bounsReasonOtherInput.value = '{{ form.bounsReasonOther.initial|escapejs }}';
      }
    }
  }
  
  // Listen for changes
  if (bounsReasonSelect) {
    bounsReasonSelect.addEventListener('change', toggleOtherField);
  }
});
</script>
{% endblock extra_js %}
